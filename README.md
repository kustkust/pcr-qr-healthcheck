# pcr-qr-healthcheck

## Отправка сообщения о состоянии

Для отправки сообщения о состоянии нужно послать на соответствующий канал json следующего вида
```json
{
  "name": "unique_name",
  "status": "string_describing_status"
}
```

## Настройки скрипта в файле `.env`
- `PROJECT_NAME` - имя проекта, используется для названия логов
- `CHECK_INTERVAL` - интервал ***в секундах*** через который производится проверка, когда последний раз было получено сообщение о состоянии
- `RESPONSE_INTERVAL` - максимальное время ожидания сообщения о состоянии ***в секундах***, при превышении этого времени делается запись в лог о том что камера/скрипт перестал отвечать
- `REDIS_HOST` - хост для redis (если программа запущена в docker, а redis локально на этой же машине можно использовать `host.docker.internal`)
- `REDIS_PORT` - порт для redis
- `FASTAPI_HOST` - хост для fastapi
- `FASTAPI_PORT` - порт для fastapi, при изменении так же нужно поменять его в docker-compose.yml
- `CAMERA_CHANNEL` - название канала для публикации состояния камер
- `SCRIPT_CHANNEL` - название канала для публикации состояния скриптов
- `OWEN_CHANNEL` - название канала для публикации состояния овнов
- `CAMERAS` - уникальные имена для каждой камеры, пишутся в формате `json` например `'["Uchaly0", "Uchaly1", "Urga0"]'`
- `SCRIPTS` - уникальные имена для каждого скрипта, пишутся в формате `json`, например `'["Uchaly", "Urga"]'`
- `OWENS` - уникальные имена для каждого овна, пишутся в формате `json`, например `'["Owen1"]'`
- `LOG_BACKUP_COUNT` - максимальное количество хранимых файлов логов, один файл - один день
- `LOG_PATH` - папка для логов, например `./logs/`
- `LOCAL_LOG_LEVEL` - уровень логов, например `INFO`

## Docker
Для создания образа
```commandline
docker build -t pcr-qr-healthcheck .
```
Для запуска образа 
```commandline
docker compose up
```

## Апи для получения данных о текущем состоянии
Состояние каждого объекта описывается следующим форматом
```json
{
  "name": "name1",
  "status": "status",
  "last_notification_time":"2023-03-01T21:53:51.842724"
}
```
### `get_item_status`
GET-запрос, отправляет данные о конкретном объекте

*Параметры*:
- `channel` - имя канала, к которому принадлежит объект (тот же что и redis)
- `name` - имя самого объекта

### `get_channel_status`
GET-запрос, отправляет данные об объектах в канале в виде массива данных об объектах в канале

*Параметры*:
- `channel` - имя канала, о котором хотим получить информацию
При этом в качестве ответа придёт массив.

### `get_status`
GET-запрос, отправляет данные обо всех объектах в виде словаря, ключ - имя канала, значение массив данных об объектах в канале